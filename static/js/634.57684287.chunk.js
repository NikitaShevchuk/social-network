"use strict";(self.webpackChunksocial_network=self.webpackChunksocial_network||[]).push([[634],{4634:function(e,s,n){n.r(s),n.d(s,{default:function(){return se}});var r=n(8683),a=n(2791),t=n(6871),o=n(8687),c=n(885),i=n(3483),u=n(6853),l=n(1363),d=n(3174),g=n(184),m=function(e){var s=e.searchMode,n=e.setSearchMode;return(0,g.jsxs)("div",{className:"sidebarHeader",children:[s&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("span",{className:"text opacity-animation",children:"Find people"}),(0,g.jsx)(l.G,{className:"opacity-animation",onClick:function(){return n(!1)},icon:d.g82})]}),!s&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("span",{className:"text opacity-animation",children:"Messages"}),(0,g.jsx)(l.G,{className:"opacity-animation",onClick:function(){return n(!0)},icon:d.g6h})]})]})},f=n(5078),h=n(1544),p=n(2519),x=function(e){var s=e.filterDialogs,n=e.setDialogs,r=Number((0,t.UO)().userId);return(0,g.jsxs)("div",{className:"search-users pointer",children:[(0,g.jsx)(l.G,{icon:d.wn1}),(0,g.jsx)(f.l0,{onSubmit:function(e){s(e.searchBody)},render:function(e){var s=e.handleSubmit,a=e.form;return(0,g.jsx)("form",{onSubmit:s,children:(0,g.jsx)(f.gN,{name:"searchBody",autoFocus:!0,validate:h.C1,onKeyUp:function(e){return function(e,s){(0,p.j)(e,s,n,r),s.submit()}(e,a)},component:"input",placeholder:"Find dialog by name",className:"search-users__input"})})}})]})},S=n(2032),A=(0,o.$j)((function(e){return{}}),{filterDialogs:u.J_,setDialogs:u.ow})((function(e){var s=e.filterDialogs,n=e.setDialogs,r=(0,a.useState)(!1),t=(0,c.Z)(r,2),o=t[0],u=t[1];return(0,g.jsxs)("ul",{className:"peoples",children:[(0,g.jsx)(m,{searchMode:o,setSearchMode:u}),(0,g.jsx)("div",{className:o?"shown":"hidden",children:(0,g.jsx)(i.Z,{setSearchMode:u,startDialogOnClick:!0})}),(0,g.jsxs)("div",{className:o?"hidden":"shown",children:[(0,g.jsx)(x,{setDialogs:n,filterDialogs:s}),(0,g.jsx)(S.Z,{className:"messages-page-dialogs"})]})]})})),v=n(8214),E=n(5861),j=function(e){return{type:"messages-reducer/SET_MORE_MESSAGES",messages:e}},M=function(e){return{type:"messages-reducer/SET_MESSAGES",messages:e}},N=function(e){return{type:"messages-reducer/SET_TOTAL_MESSAGES_COUNT",count:e}},b=function(e){return{type:"messages-reducer/UPDATE_MESSAGES",newMessages:e}},y=function(e){return{type:"messages-reducer/ADD_NEW_MESSAGE",newMessage:e}},U=function(e){return{type:"messages-reducer/SET_PAGE_NUMBER",pageNumber:e}},Z=function(e){return{type:"messages-reducer/SET_IS_MESSAGES_LOADED",isLoaded:e}},T=function(){return{type:"messages-reducer/CLEAR_MESSAGES_ERROR"}},w=function(e){return{type:"messages-reducer/SET_IS_MESSAGES_LOADING",isLoading:e}},C=function(e){return{type:"messages-reducer/SET_IS_MESSAGES_FETCHING",isFetching:e}},k=U,D=function(e){return{type:"messages-reducer/SET_DIALOG_USER_ID",userId:e}},F=Z,H=n(3692),L=n(1468),I=n(1834),G=n(8997),R=function(e,s){return!e[0]||!s[0]||s[s.length-1].id===e[e.length-1].id},Q=n(220);var O=n.p+"static/media/send.2ec83b7d2370fbd448eddc161ecfe473.svg",B=function(e){var s=e.sendMessage;return(0,g.jsx)("div",{className:"message-text-container",children:(0,g.jsx)(f.l0,{onSubmit:s,render:function(e){var s=e.handleSubmit,n=e.submitting,r=e.pristine,a=e.form;return(0,g.jsxs)("form",{className:"add-message-form",onSubmit:s,children:[(0,g.jsx)(f.gN,{onKeyDown:function(e){return function(e,s){"Enter"===e.key&&(e.preventDefault(),s.submit(),s.reset())}(e,a)},name:"body",component:"textarea",placeholder:"Text a message"}),(0,g.jsx)("button",{disabled:n||r,onClick:function(){return function(e){e.submit(),e.reset()}(a)},children:(0,g.jsx)("img",{src:O,alt:""})})]})}})})},_=n(6083),q=n(3504),P=(0,o.$j)((function(e){return{conversationHead:e.dialogsPage.conversationHead}}),{})((function(e){var s=e.conversationHead,n=s.photo?s.photo:_;return(0,g.jsxs)(q.OL,{replace:!0,to:"/profile/".concat(s.id),className:"conversation-head",children:[(0,g.jsx)("figure",{children:(0,g.jsx)("img",{src:n,alt:""})}),(0,g.jsx)("span",{children:s.userName})]})})),K=n(5095),V=n.n(K),W=function(e){if(!e)return!1;var s=e.scrollHeight-e.offsetHeight-32;return e.scrollTop+70<s},J=function(e,s,n,r){(0,a.useEffect)((function(){!function(e){e&&(W(e)||(e.scrollTop=e.scrollHeight))}(s)}),[e]),(0,a.useEffect)((function(){r.isLoading||n.current||(s&&(s.scrollTop=s.scrollHeight),n.current=!0)}),[r.isLoading]),(0,a.useEffect)((function(){var e=!r.isFetching&&!r.allMessagesIsLoaded;s&&e&&(s.scrollTop=1100)}),[r.isFetching])},z=n(2195),Y=n.n(z),X=function(e){var s=e.messages,n=e.sendNewMessage,r=e.status,o=e.loadMoreMessages,i=Number((0,t.UO)().userId),u=(0,a.useState)(null),l=(0,c.Z)(u,2),d=l[0],m=l[1],f=(0,a.useRef)(!1);J(s,d,f,r);var h=function(e,s,n){var r=(0,a.useState)(!1),t=(0,c.Z)(r,2),o=t[0],i=t[1],u=(0,a.useCallback)(V()(e,500),[]);return{handleScrollClick:function(){s&&(s.scrollTop=s.scrollHeight)},handleScroll:function(){W(s)?!o&&i(!0):o&&i(!1),s&&s.scrollTop<30&&n&&u()},showScrollButton:o}}(o,d,f),p=h.handleScrollClick,x=h.handleScroll,S=h.showScrollButton;return(0,g.jsxs)("div",{className:"peoples-mesg-box",children:[i&&(0,g.jsxs)("div",{className:"chatArea opacity-animation",children:[(0,g.jsx)(P,{}),(0,g.jsxs)(Y(),{className:"chatting-area",component:"ul",containerRef:function(e){return m(e)},onScroll:x,children:[(0,g.jsx)(Q.Z,{isFetching:r.isFetching,size:"small"}),r.isLoading&&(0,g.jsx)(Q.Z,{}),s[0]?!r.isLoading&&s:!r.isLoading&&(0,g.jsx)("div",{className:"preloader",children:"You've got no messages yet."})]}),S&&(0,g.jsx)("img",{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACoAAAAqCAYAAADFw8lbAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAO8SURBVFhH7ZlLaBNRFIY7kzRJ0yRto5FuFMQWBZcqKFaQUq21FoQq4mPhA0QX4rJuRNduBHc+qAiKUFHUUh8VEZcuWgQVUSuKCwVj0iapTdO8/M7kVtT0kSbTOoV+kOTce2bu/efcd0Yr+wNd15e43e4TTqdzh91ur9c0rVK55oRsNvszlUq9TyQSPSMjIxcymUxQucp+C3W5XLuqqqo6EedVWf8VREcjkcih0dHRO5K2yZeIrK6u7kKkU9JWQLSgazcRfs3nrSbNHQgEBqwSyX8hspFgMFhvq6ysPEWf3KLyLQcBdCE2rhPeNpVnWQhkm26z2VaotGVhBqrTCa1HpS2LjB9d2ZZnQajZLAg1m/kvNBQKbeSzlh3MV5U1a0gd1LUmHA5vUll5TBXRsWQy2SeC0+n0B5VnOlK21EFd/SyVCZWdx6RC2U31OhwOEfmZgjZQ0AvlMo2xsbF+ym6QOsrLy9dR5wPlymNSoSytNSKWdXYbTROiWZoo+Ilylwyb4+eDg4ONlP2dgDT6/f6n1LlYufOYcjCxBXSzmb7HxmUPzTJMwW1sZG8pd9Eg8v7Q0FCLbOEoeycB6ZlumzmlUAGxDgq6yRHlpPQhKtjLMeGScs8Y7r3GA7fL1o0yj1H2bepwKfek2Dwez1llT4UmXYCnrpDmlzONZNJkmw1vgcg5KBqNHsfMsA/u8Pl857GnDZZQqFADhDXw9IsQ+hjBz+hfYR6gGddfh8QJyMZisY7h4eHT2JrX6z1HvWfENrwFoNXW1maVXTDxePw6B6/DmMmKior99OOr2OWGM5801x7lnk5sG9de5J4jOVfhFCVUIKrd9FcZZHGi2oqALhl8ym1AxBM09T45SdJtnFxzg8HTrtwzoqD+MRFyPGAgPESAT/qsTDXMhyHlFpE8x1CTEumpqanpLlakUHREx6Gv9iFou8yHHBlWI/4RkbUjvIVF4iW2H5E9TOjr1S1FUbJQAUHvELuViH5h0l4uedifsJchvBeRK40LS8AUoQIR/cbq1ZxKpV5JmuiuEpH8LjUuKBHThApEMUxkWzGT0n+JaCDnKR1ThQrMAjH5nW5JnClFj/rJEIFmixRMFzpbLAg1m/kjdHyUWhk0RnUm6I8qbVlY+QZ02QWptGVhP9Etf40H1F/jPpVvKWh2+Wu8TmeNDsrbB/IyOZelyKDtIBp/GG9F5K2DvH1Q56JpD1pzgUQS9rOfvStpQ6ggYjkuXOGCUZJeuoQshY6cd26QGYiB8wYdlxF5ALs/5ykr+wUuwtPz9MCTQwAAAABJRU5ErkJggg==",alt:"",className:"scroll-bottom opacity-animation",onClick:p}),(0,g.jsx)(B,{sendMessage:function(e){return n(e)}})]}),!i&&(0,g.jsx)("div",{className:"fetch-error",children:"Choose friend to start chat"})]})},$=n(4025),ee=(0,o.$j)((function(e){return{messages:(0,$.xq)(e),totalMessagesCount:(0,$.bp)(e),pageNumber:(0,$.p6)(e),status:(0,$.RL)(e)}}),{sendNewMessage:function(e){return function(){var s=(0,E.Z)((0,v.Z)().mark((function s(n,r){var a,t,o;return(0,v.Z)().wrap((function(s){for(;;)switch(s.prev=s.next){case 0:return a=r().messagesPage.dialogUserId,s.prev=1,s.next=4,H.o.sendMessage(a,e);case 4:(t=s.sent).resultCode===L.Td.Success?(o=t.data.message,n(y(o))):n(I.xZ.addError(t.messages[0])),s.next=11;break;case 8:s.prev=8,s.t0=s.catch(1),n(I.xZ.addError("Can't send message"));case 11:case"end":return s.stop()}}),s,null,[[1,8]])})));return function(e,n){return s.apply(this,arguments)}}()},loadMessages:function(){return function(){var e=(0,E.Z)((0,v.Z)().mark((function e(s,n){var r,a,t;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s(w(!0)),r=n().messagesPage.dialogUserId,s((function(e,s){var n=s().messagesPage.dialogUserId;e(U(1)),e(Z(!1)),e(T()),e(G.G.setConversationHead(n))})),e.prev=3,a=n().messagesPage.count,e.next=7,H.o.requireMessages(r,a,1);case 7:t=e.sent,s(M(t.items)),s(N(t.totalCount)),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(3),s(I.xZ.addError("Can't load messages"));case 15:s(w(!1));case 16:case"end":return e.stop()}}),e,null,[[3,12]])})));return function(s,n){return e.apply(this,arguments)}}()},fetchMessages:function(){return function(){var e=(0,E.Z)((0,v.Z)().mark((function e(s,n){var r,a,t,o,c,i;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=n().messagesPage,a=r.count,t=r.dialogUserId,e.next=4,H.o.requireMessages(t,a,1);case 4:o=e.sent,c=n().messagesPage,i=c.messages,c.messagesError&&s(T()),!R(i,o.items)&&(s(b(o.items)),s(N(o.totalCount))),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(0),s(I.xZ.addError("Can't load messages"));case 14:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(s,n){return e.apply(this,arguments)}}()},setIsAllMessagesLoaded:F,setPageNumber:k,loadMoreMessages:function(){return function(){var e=(0,E.Z)((0,v.Z)().mark((function e(s,n){var r,a,t,o,c,i,u,l,d,g,m;return(0,v.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n().messagesPage,a=r.dialogUserId,t=r.messages,o=r.pageNumber,c=r.status,e.next=3,H.o.requireLastMessage(a);case 3:if(i=e.sent,i.totalCount!==t.length){e.next=8;break}return c.allMessagesIsLoaded||s(Z(!0)),e.abrupt("return");case 8:return s(C(!0)),c.allMessagesIsLoaded&&s(Z(!1)),s(U(o+1)),e.prev=11,u=n().messagesPage,l=u.pageNumber,d=u.count,e.next=15,H.o.requireMessages(a,d,l);case 15:g=e.sent,s(j(g.items)),s(N(g.totalCount)),e.next=25;break;case 20:e.prev=20,e.t0=e.catch(11),m=n().messagesPage.pageNumber,s(U(m-1)),s(I.xZ.addError("Can't load messages"));case 25:s(C(!1));case 26:case"end":return e.stop()}}),e,null,[[11,20]])})));return function(s,n){return e.apply(this,arguments)}}()},setDialogUserId:D}),se=ee((function(e){var s=Number((0,t.UO)().userId);return(0,a.useEffect)((function(){s&&(e.setDialogUserId(s),e.loadMessages());var n=!!s&&setInterval((function(){return e.fetchMessages()}),1500);return function(){n&&clearInterval(n)}}),[s]),(0,g.jsx)("div",{className:"central-meta messages",children:(0,g.jsx)("div",{className:"messages",children:(0,g.jsxs)("div",{className:"message-box",children:[(0,g.jsx)(A,{}),(0,g.jsx)(X,(0,r.Z)({},e))]})})})}))}}]);
//# sourceMappingURL=634.57684287.chunk.js.map