import{j as i,m as N,a as t,F as A,I as U,J as F,H as E,K as v,R as y,b as C,x as L,L as D,r as d,N as w,O as H,g as p,Q as P,S as Q,T as m,l as S,i as R,V as k,W as O,X as G,Y as B,Z as q,o as f,_,$ as x,a0 as K,a1 as V}from"./index-3fd4c2dc.js";const W=({searchMode:e,setSearchMode:s})=>i("div",{className:"sidebarHeader",children:[e&&i(N,{children:[t("span",{className:"text opacity-animation",children:"Find people"}),t(A,{className:"opacity-animation",onClick:()=>s(!1),icon:U})]}),!e&&i(N,{children:[t("span",{className:"text opacity-animation",children:"Messages"}),t(A,{className:"opacity-animation",onClick:()=>s(!0),icon:F})]})]}),Z=({filterDialogs:e,setDialogs:s})=>{const o=Number(E().userId),a=l=>{e(l.searchBody)},r=(l,c)=>{D(l,c,s,o),c.submit()};return i("div",{className:"search-users pointer",children:[t(A,{icon:v}),t(y,{onSubmit:a,render:({handleSubmit:l,form:c})=>t("form",{onSubmit:l,children:t(C,{name:"searchBody",autoFocus:!0,validate:L,onKeyUp:g=>r(g,c),component:"input",placeholder:"Find dialog by name",className:"search-users__input"})})})]})},j=({filterDialogs:e,setDialogs:s})=>{const[o,a]=d.useState(!1);return i("ul",{className:"peoples",children:[t(W,{searchMode:o,setSearchMode:a}),t("div",{className:o?"shown":"hidden",children:t(w,{setSearchMode:a,startDialogOnClick:!0})}),i("div",{className:o?"hidden":"shown",children:[t(Z,{setDialogs:s,filterDialogs:e}),t(H,{className:"messages-page-dialogs"})]})]})},J=()=>({}),z=p(J,{filterDialogs:P,setDialogs:Q}),Y=z(j),n={setDialogUserId:e=>({type:"messages-reducer/SET_DIALOG_USER_ID",userId:e}),setMoreMessages:e=>({type:"messages-reducer/SET_MORE_MESSAGES",messages:e}),setMessages:e=>({type:"messages-reducer/SET_MESSAGES",messages:e}),setTotalMessagesCount:e=>({type:"messages-reducer/SET_TOTAL_MESSAGES_COUNT",count:e}),updateMessages:e=>({type:"messages-reducer/UPDATE_MESSAGES",newMessages:e}),addNewMessage:e=>({type:"messages-reducer/ADD_NEW_MESSAGE",newMessage:e}),setPageNumber:e=>({type:"messages-reducer/SET_PAGE_NUMBER",pageNumber:e}),setCount:e=>({type:"messages-reducer/SET_COUNT",count:e}),setIsAllMessagesLoaded:e=>({type:"messages-reducer/SET_IS_MESSAGES_LOADED",isLoaded:e}),setMessagesError:e=>({type:"messages-reducer/SET_MESSAGES_ERROR",errorText:e}),clearMessagesError:()=>({type:"messages-reducer/CLEAR_MESSAGES_ERROR"}),setIsMessagesLoading:e=>({type:"messages-reducer/SET_IS_MESSAGES_LOADING",isLoading:e}),setIsMessagesFetching:e=>({type:"messages-reducer/SET_IS_MESSAGES_FETCHING",isFetching:e})},{setPageNumber:X,setDialogUserId:$,setIsAllMessagesLoaded:ee}=n,se=()=>(e,s)=>{const{dialogUserId:o}=s().messagesPage;e(n.setPageNumber(1)),e(n.setIsAllMessagesLoaded(!1)),e(n.clearMessagesError()),e(k.setConversationHead(o))},ae=()=>async(e,s)=>{e(n.setIsMessagesLoading(!0));const{dialogUserId:o}=s().messagesPage;e(se());try{const{count:a}=s().messagesPage,r=await m.requireMessages(o,a,1);e(n.setMessages(r.items)),e(n.setTotalMessagesCount(r.totalCount))}catch{e(S.addError("Can't load messages"))}e(n.setIsMessagesLoading(!1))},oe=(e,s)=>{if(!e[0]||!s[0])return!0;const o=s[s.length-1].id,a=e[e.length-1].id;return o===a},te=()=>async(e,s)=>{try{const{count:o,dialogUserId:a}=s().messagesPage,r=await m.requireMessages(a,o,1),{messages:l,messagesError:c}=s().messagesPage;c&&e(n.clearMessagesError()),!oe(l,r.items)&&(e(n.updateMessages(r.items)),e(n.setTotalMessagesCount(r.totalCount)))}catch{e(S.addError("Can't load messages"))}},re=()=>async(e,s)=>{const{dialogUserId:o,messages:a,pageNumber:r,status:l}=s().messagesPage,{totalCount:c}=await m.requireLastMessage(o);if(c===a.length){l.allMessagesIsLoaded||e(n.setIsAllMessagesLoaded(!0));return}e(n.setIsMessagesFetching(!0)),l.allMessagesIsLoaded&&e(n.setIsAllMessagesLoaded(!1)),e(n.setPageNumber(r+1));try{const{pageNumber:g,count:u}=s().messagesPage,h=await m.requireMessages(o,u,g);e(n.setMoreMessages(h.items)),e(n.setTotalMessagesCount(h.totalCount))}catch{const{pageNumber:g}=s().messagesPage;e(n.setPageNumber(g-1)),e(S.addError("Can't load messages"))}e(n.setIsMessagesFetching(!1))},ne=e=>async(s,o)=>{const a=o().messagesPage.dialogUserId;try{const r=await m.sendMessage(a,e);if(r.resultCode===R.Success){const l=r.data.message;s(n.addNewMessage(l))}else s(S.addError(r.messages[0]))}catch{s(S.addError("Can't send message"))}},le="https://nikitashevchuk.github.io/social-network/assets/send-a661bbf2.svg",ce=({sendMessage:e})=>{const s=(a,r)=>{a.key==="Enter"&&(a.preventDefault(),r.submit(),r.reset())},o=a=>{a.submit(),a.reset()};return t("div",{className:"message-text-container",children:t(y,{onSubmit:e,render:({handleSubmit:a,submitting:r,pristine:l,form:c})=>i("form",{className:"add-message-form",onSubmit:a,children:[t(C,{onKeyDown:g=>s(g,c),name:"body",component:"textarea",placeholder:"Text a message"}),t("button",{type:"button",disabled:r||l,onClick:()=>o(c),children:t("img",{src:le,alt:""})})]})})})},ie=({conversationHead:e})=>{const s=e.photo?e.photo:O;return i(G,{replace:!0,to:`/profile/${e.id}`,className:"conversation-head",children:[t("figure",{children:t("img",{src:s,alt:""})}),t("span",{children:e.userName})]})},ge=e=>({conversationHead:e.dialogsPage.conversationHead}),de=p(ge,{}),ue=de(ie),T=e=>{if(!e)return!1;const s=e.scrollHeight-e.offsetHeight-32;return e.scrollTop+70<s},me=e=>{if(!e)return;T(e)||(e.scrollTop=e.scrollHeight)},Se=(e,s,o,a)=>{d.useEffect(()=>{me(s)},[e]),d.useEffect(()=>{!a.isLoading&&!o.current&&(s&&(s.scrollTop=s.scrollHeight),o.current=!0)},[a.isLoading]),d.useEffect(()=>{const r=!a.isFetching&&!a.allMessagesIsLoaded;s&&r&&(s.scrollTop=1100)},[a.isFetching])},he=(e,s,o)=>{const[a,r]=d.useState(!1),l=d.useCallback(B(e,500),[]);return{handleScrollClick:()=>{s&&(s.scrollTop=s.scrollHeight)},handleScroll:()=>{if(T(s)?a||r(!0):a&&r(!1),!s)return;s.scrollTop<30&&o&&l()},showScrollButton:a}},Me="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACoAAAAqCAYAAADFw8lbAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAO8SURBVFhH7ZlLaBNRFIY7kzRJ0yRto5FuFMQWBZcqKFaQUq21FoQq4mPhA0QX4rJuRNduBHc+qAiKUFHUUh8VEZcuWgQVUSuKCwVj0iapTdO8/M7kVtT0kSbTOoV+kOTce2bu/efcd0Yr+wNd15e43e4TTqdzh91ur9c0rVK55oRsNvszlUq9TyQSPSMjIxcymUxQucp+C3W5XLuqqqo6EedVWf8VREcjkcih0dHRO5K2yZeIrK6u7kKkU9JWQLSgazcRfs3nrSbNHQgEBqwSyX8hspFgMFhvq6ysPEWf3KLyLQcBdCE2rhPeNpVnWQhkm26z2VaotGVhBqrTCa1HpS2LjB9d2ZZnQajZLAg1m/kvNBQKbeSzlh3MV5U1a0gd1LUmHA5vUll5TBXRsWQy2SeC0+n0B5VnOlK21EFd/SyVCZWdx6RC2U31OhwOEfmZgjZQ0AvlMo2xsbF+ym6QOsrLy9dR5wPlymNSoSytNSKWdXYbTROiWZoo+Ilylwyb4+eDg4ONlP2dgDT6/f6n1LlYufOYcjCxBXSzmb7HxmUPzTJMwW1sZG8pd9Eg8v7Q0FCLbOEoeycB6ZlumzmlUAGxDgq6yRHlpPQhKtjLMeGScs8Y7r3GA7fL1o0yj1H2bepwKfek2Dwez1llT4UmXYCnrpDmlzONZNJkmw1vgcg5KBqNHsfMsA/u8Pl857GnDZZQqFADhDXw9IsQ+hjBz+hfYR6gGddfh8QJyMZisY7h4eHT2JrX6z1HvWfENrwFoNXW1maVXTDxePw6B6/DmMmKior99OOr2OWGM5801x7lnk5sG9de5J4jOVfhFCVUIKrd9FcZZHGi2oqALhl8ym1AxBM09T45SdJtnFxzg8HTrtwzoqD+MRFyPGAgPESAT/qsTDXMhyHlFpE8x1CTEumpqanpLlakUHREx6Gv9iFou8yHHBlWI/4RkbUjvIVF4iW2H5E9TOjr1S1FUbJQAUHvELuViH5h0l4uedifsJchvBeRK40LS8AUoQIR/cbq1ZxKpV5JmuiuEpH8LjUuKBHThApEMUxkWzGT0n+JaCDnKR1ThQrMAjH5nW5JnClFj/rJEIFmixRMFzpbLAg1m/kjdHyUWhk0RnUm6I8qbVlY+QZ02QWptGVhP9Etf40H1F/jPpVvKWh2+Wu8TmeNDsrbB/IyOZelyKDtIBp/GG9F5K2DvH1Q56JpD1pzgUQS9rOfvStpQ6ggYjkuXOGCUZJeuoQshY6cd26QGYiB8wYdlxF5ALs/5ykr+wUuwtPz9MCTQwAAAABJRU5ErkJggg==",Ae=({messages:e,sendNewMessage:s,status:o,loadMoreMessages:a})=>{const r=Number(E().userId),l=M=>s(M),[c,g]=d.useState(null),u=d.useRef(!1);Se(e,c,u,o);const{handleScrollClick:h,handleScroll:I,showScrollButton:b}=he(a,c,u);return i("div",{className:"peoples-mesg-box",children:[r&&i("div",{className:"chatArea opacity-animation",children:[t(ue,{}),i(q,{className:"chatting-area",component:"ul",containerRef:M=>g(M),onScroll:I,children:[t(f,{isFetching:o.isFetching,size:"small"}),o.isLoading&&t(f,{}),e[0]?!o.isLoading&&e:!o.isLoading&&t("div",{className:"preloader",children:"You've got no messages yet."})]}),b&&t("img",{src:Me,alt:"",className:"scroll-bottom opacity-animation",onClick:h}),t(ce,{sendMessage:l})]}),!r&&t("div",{className:"fetch-error",children:"Choose friend to start chat"})]})},Ee=e=>{const s=Number(E().userId);return d.useEffect(()=>{s&&(e.setDialogUserId(s),e.loadMessages());const a=(()=>s?setInterval(()=>e.fetchMessages(),1500):!1)();return()=>{a&&clearInterval(a)}},[s]),t("div",{className:"central-meta messages",children:t("div",{className:"messages",children:i("div",{className:"message-box",children:[t(Y,{}),t(Ae,{...e})]})})})},pe=e=>({messages:_(e),totalMessagesCount:x(e),pageNumber:K(e),status:V(e)}),Ne=p(pe,{sendNewMessage:ne,loadMessages:ae,fetchMessages:te,setIsAllMessagesLoaded:ee,setPageNumber:X,loadMoreMessages:re,setDialogUserId:$}),Ce=Ne(Ee);export{Ce as default};
